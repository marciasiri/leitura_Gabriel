<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alfabeto do Gabriel</title>
    <!-- Fontes e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --success-color: #58D68D;
            --skip-color: #AAB7B8;
            --level-color-1: #FF6B6B;
            --level-color-2: #3498db;
            --level-color-3: #9b59b6;
            --level-color-4: #f39c12;
            --level-color-5: #e67e22;
            --level-color-6: #1abc9c;
            --text-color: #2F2F2F;
            --bg-color: #F7FFF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Fredoka One', cursive;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-y: auto; min-height: 100vh;
            display: flex; flex-direction: column;
        }

        header {
            padding: 10px; text-align: center; background-color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }

        .header-top {
            display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
        }

        #instruction-bar {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 5px;
            animation: pulse-light 2s infinite;
        }

        @keyframes pulse-light {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .level-selector {
            background: #eee;
            border: 2px solid #ccc;
            padding: 8px 15px;
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            outline: none;
        }

        .game-container {
            display: flex; flex: 1; padding: 15px; gap: 15px;
            align-items: center; justify-content: center; padding-bottom: 100px;
        }

        .card-side {
            flex: 1; background: white; border-radius: 30px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 10px 10px 0px var(--secondary-color);
            border: 4px solid var(--text-color); height: 400px; max-width: 45%;
            transition: all 0.3s ease;
        }

        .animal-img {
            max-width: 95%; max-height: 320px; object-fit: contain;
            margin-bottom: 10px; border-radius: 20px;
        }

        .drawing-side {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative; width: 100%;
        }

        #canvas-container {
            position: relative; background: white; border-radius: 30px;
            border: 6px dashed var(--primary-color);
            box-shadow: 10px 10px 0px var(--accent-color);
            cursor: crosshair; overflow: hidden; transition: all 0.3s ease;
            touch-action: none; margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
            width: 400px; height: 400px;
        }

        #letter-canvas { display: block; width: 100%; height: 100%; }

        #drag-drop-container {
            display: none; flex-direction: column; align-items: center; gap: 30px; width: 100%;
        }

        .drop-zone {
            width: 180px; height: 180px; border-radius: 30px; display: flex;
            align-items: center; justify-content: center; font-size: 5rem;
            position: relative; transition: all 0.3s;
        }
        
        body.level-1 #canvas-container { border-color: var(--level-color-1); }
        body.level-2 #canvas-container { border-color: var(--level-color-2); }
        body.level-3 .drop-zone { border: 6px dashed var(--level-color-3); color: var(--level-color-3); background: rgba(155, 89, 182, 0.05); }
        body.level-4 #canvas-container { border-color: var(--level-color-4); }
        body.level-5 #canvas-container { border-color: var(--level-color-5); }
        body.level-6 .drop-zone { border: 6px dashed var(--level-color-6); color: var(--level-color-6); background: rgba(26, 188, 156, 0.05); }

        .options-container {
            display: flex; gap: 20px; justify-content: center; width: 100%;
        }

        .letter-card {
            width: 100px; height: 120px; background: white; border: 4px solid var(--text-color);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; cursor: grab; transition: transform 0.2s, box-shadow 0.2s;
            touch-action: none;
        }
        body.level-3 .letter-card { box-shadow: 5px 5px 0px var(--level-color-3); }
        body.level-6 .letter-card { box-shadow: 5px 5px 0px var(--level-color-6); }
        
        .letter-card:active { cursor: grabbing; transform: scale(1.1); z-index: 100; }
        .letter-card.dragging { opacity: 0.5; }

        @keyframes blink-red {
            0%, 100% { border-color: var(--primary-color); background-color: white; }
            50% { border-color: #e74c3c; background-color: #fadbd8; transform: scale(1.02); }
        }
        .blink-error { animation: blink-red 0.3s ease-in-out 3; }

        @keyframes pulse-check {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 15px var(--success-color); }
        }

        .controls {
            margin-top: 20px; display: flex; gap: 25px;
            min-height: 80px; align-items: center; justify-content: center; width: 100%;
        }

        .btn {
            border: none; border-radius: 50%; width: 60px; height: 60px;
            font-size: 1.5rem; cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15); gap: 10px;
        }

        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
        .btn-audio { 
            background-color: var(--secondary-color); color: white; border-radius: 50px; 
            width: auto; padding: 10px 25px; height: auto; gap: 10px;
        }
        
        .btn-retry, .btn-check, .btn-skip { display: none; }
        .btn-retry { background-color: var(--primary-color); color: white; }
        .btn-check { 
            background-color: var(--success-color); color: white; width: 80px; height: 80px; font-size: 2.2rem;
            animation: pulse-check 2s infinite ease-in-out;
        }
        .btn-skip { background-color: var(--skip-color); color: white; }
        
        .btn-next { 
            background-color: var(--success-color); color: white; position: fixed; bottom: 20px; right: 20px;
            padding: 20px 40px; font-size: 2rem; display: none; z-index: 100; border-radius: 50px; width: auto; height: auto;
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            border-radius: 30px; z-index: 50; text-align: center; padding: 15px;
        }

        .star-icon { font-size: 6rem; color: var(--accent-color); filter: drop-shadow(0 0 10px orange); }

        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-color);
            display: flex; align-items:center; justify-content: center; z-index: 200; font-size: 2rem;
        }

        @keyframes fall { to { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .confetti-star { position: absolute; font-size: 2rem; pointer-events: none; z-index: 60; animation: fall linear forwards; }
        .bounce { animation: bounce 0.6s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .pop-in { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @media (max-width: 850px) {
            header { gap: 5px; padding: 10px 5px; }
            .header-top { gap: 10px; }
            #instruction-bar { font-size: 0.9rem; padding: 5px 15px; }
            .game-container { flex-direction: column; padding-bottom: 120px; }
            .card-side { width: 90vw; height: 300px; max-width: 95%; margin-bottom: 20px; }
            #canvas-container { width: 90vw; height: 90vw; max-width: 320px; max-height: 320px; }
            .options-container { gap: 10px; }
            .letter-card { width: 80px; height: 100px; font-size: 2.5rem; }
        }
    </style>
</head>
<body>

    <div id="loader">Carregando jogo do Gabriel...</div>

    <header>
        <div class="header-top">
            <h1 id="game-title" style="margin:0; font-size: 1.5rem;">Gabriel - N√≠vel 1</h1>
            <select class="level-selector" id="level-select" onchange="jumpToLevel(this.value)">
                <option value="1">N√≠vel 1 (Mai√∫sculas - Desenhar)</option>
                <option value="2">N√≠vel 2 (Mai√∫sculas - Apagar)</option>
                <option value="3">N√≠vel 3 (Mai√∫sculas - Arrastar)</option>
                <option value="4">N√≠vel 4 (Min√∫sculas - Desenhar)</option>
                <option value="5">N√≠vel 5 (Min√∫sculas - Apagar)</option>
                <option value="6">N√≠vel 6 (Min√∫sculas - Arrastar)</option>
            </select>
        </div>
        <div id="instruction-bar">Instru√ß√£o</div>
    </header>

    <div class="game-container">
        <div class="card-side pop-in" id="card-side">
            <img src="" alt="" id="animal-image" class="animal-img">
            <div id="audio-central-msg" style="display:none; font-size: 1.2rem; margin-bottom: 20px; text-align: center;">Ou√ßa e arraste a letra!</div>
            <button class="btn btn-audio" id="audio-btn" onclick="speakCurrent()">
                <i class="fas fa-volume-high"></i>&nbsp;Ouvir
            </button>
        </div>

        <div class="drawing-side">
            <div id="canvas-container">
                <canvas id="letter-canvas"></canvas>
                
                <div id="congrats-overlay" class="overlay">
                    <div class="star-icon bounce">‚≠ê</div>
                    <h2 style="font-size: 2.2rem; color: var(--success-color); margin: 10px 0;">MUITO BEM!</h2>
                </div>

                <div id="level-complete-overlay" class="overlay">
                    <div class="star-icon bounce">üèÜ</div>
                    <h2 id="level-msg" style="font-size: 1.5rem; color: var(--primary-color); margin: 15px 0;">Parab√©ns Gabriel!</h2>
                    <button class="btn btn-audio proeminent" style="width:100%; max-width: 250px; background-color: var(--success-color); border-radius: 50px;" onclick="startNextLevel()">
                        Continuar <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div id="drag-drop-container">
                <div class="drop-zone" id="drop-zone">
                    <i class="fas fa-question"></i>
                </div>
                <div class="options-container" id="options-container"></div>
            </div>

            <div class="controls" id="standard-controls">
                <button id="retry-btn" class="btn btn-retry" onclick="resetCanvas()"><i class="fas fa-eraser"></i></button>
                <button id="check-btn" class="btn btn-check" onclick="manualCheck()"><i class="fas fa-check-circle"></i></button>
                <button id="skip-btn" class="btn btn-skip" onclick="skipLetter()"><i class="fas fa-forward"></i></button>
            </div>
        </div>
    </div>

    <button id="next-btn" class="btn btn-next pop-in" onclick="nextLetter()">Pr√≥ximo <i class="fas fa-arrow-right"></i></button>

    <canvas id="ref-canvas" style="display:none;"></canvas>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE PROTEGIDA ---
        let db, auth, appId = 'gabriel-alfabeto';
        try {
            const hasFirebase = typeof firebase !== 'undefined';
            const hasConfig = typeof __firebase_config !== 'undefined' && __firebase_config;

            if (hasFirebase && hasConfig) {
                const firebaseConfig = JSON.parse(__firebase_config);
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
            }
            if (typeof __app_id !== 'undefined') appId = __app_id;
        } catch (e) {
            console.warn("Firebase offline mode.");
        }

        // --- ESTADO DO JOGO ---
        let gameData = {
            level: 1,
            currentIndex: 0,
            alphabet: [
                { l: 'A', name: 'Abelha' }, { l: 'B', name: 'Bola' }, { l: 'C', name: 'Casa' },
                { l: 'D', name: 'Dado' }, { l: 'E', name: 'Elefante' }, { l: 'F', name: 'Faca' },
                { l: 'G', name: 'Gato' }, { l: 'H', name: 'Helic√≥ptero' }, { l: 'I', name: 'Igreja' },
                { l: 'J', name: 'Jacar√©' }, { l: 'K', name: 'Kiwi' }, { l: 'L', name: 'L√°pis' },
                { l: 'M', name: 'Macaco' }, { l: 'N', name: 'Navio' }, { l: 'O', name: 'Ovelha' },
                { l: 'P', name: 'Pato' }, { l: 'Q', name: 'Queijo' }, { l: 'R', name: 'Rato' },
                { l: 'S', name: 'Sapo' }, { l: 'T', name: 'Tesoura' }, { l: 'U', name: 'Uva' },
                { l: 'V', name: 'Vaca' }, { l: 'W', name: 'Walter' }, { l: 'X', name: 'X√≠cara' },
                { l: 'Y', name: 'Yakult' }, { l: 'Z', name: 'Zebra' }
            ]
        };

        let attemptCount = 0;
        let isDrawing = false;
        let isCompleted = false;
        let hasStartedDrawing = false;
        let visitedBlocks = new Set();
        let targetBlocks = [];
        const gridSize = 15;
        const canvasSize = { w: 400, h: 400 };

        let canvas, ctx, refCanvas, refCtx;
        const preloadedImages = {};

        // --- PERSIST√äNCIA ---
        async function saveProgress() {
            if (!db || !auth || !auth.currentUser) return;
            const user = auth.currentUser;
            try {
                await db.doc(`artifacts/${appId}/users/${user.uid}/data/progress`).set({
                    level: gameData.level,
                    currentIndex: gameData.currentIndex,
                    alphabet: gameData.alphabet,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) { console.error("Erro ao salvar:", e); }
        }

        async function loadProgress() {
            if (!db || !auth || !auth.currentUser) return;
            const user = auth.currentUser;
            try {
                const doc = await db.doc(`artifacts/${appId}/users/${user.uid}/data/progress`).get();
                if (doc.exists) {
                    const data = doc.data();
                    gameData.level = data.level || 1;
                    gameData.currentIndex = data.currentIndex || 0;
                    if (data.alphabet) gameData.alphabet = data.alphabet;
                    document.getElementById('level-select').value = gameData.level;
                }
            } catch (e) { console.error("Erro ao carregar:", e); }
        }

        // --- L√ìGICA DE JOGO ---
        function removeAccents(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

        function preloadAll() {
            gameData.alphabet.forEach(item => {
                const img = new Image();
                const imgName = `${item.l.toLowerCase()}_${removeAccents(item.name)}.jpg`;
                img.src = `https://marciasiri.github.io/leitura_Gabriel/${imgName}`;
                preloadedImages[item.l] = img;
            });
        }

        function initCanvas() {
            canvas = document.getElementById('letter-canvas');
            if (!canvas) return;
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            refCanvas = document.getElementById('ref-canvas');
            refCtx = refCanvas.getContext('2d', { willReadFrequently: true });
            canvas.width = canvasSize.w;
            canvas.height = canvasSize.h;
            refCanvas.width = canvasSize.w;
            refCanvas.height = canvasSize.h;
        }

        function renderLetterTemplate() {
            if (!ctx || gameData.level === 3 || gameData.level === 6) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            refCtx.clearRect(0, 0, refCanvas.width, refCanvas.height);
            visitedBlocks.clear();
            targetBlocks = [];
            
            let letter = gameData.alphabet[gameData.currentIndex].l;
            const isLowercaseLevel = [4, 5, 6].includes(gameData.level);
            if (isLowercaseLevel) letter = letter.toLowerCase();
            
            const fontSize = isLowercaseLevel ? "340px" : "300px";
            const guideFont = "bold " + fontSize + " sans-serif"; 
            ctx.font = guideFont; ctx.textAlign = "center"; ctx.textBaseline = "middle";

            if (gameData.level === 1 || gameData.level === 4) {
                ctx.strokeStyle = "#CCCCCC"; ctx.setLineDash([15, 15]); ctx.lineWidth = 6;
                ctx.strokeText(letter, canvas.width / 2, canvas.height / 2);
                ctx.setLineDash([]);
            } else if (gameData.level === 2 || gameData.level === 5) {
                ctx.font = "100 " + fontSize + " sans-serif"; 
                ctx.fillStyle = "#CCCCCC";
                ctx.fillText(letter, canvas.width / 2, canvas.height / 2);
            }

            refCtx.font = "bold " + fontSize + " sans-serif"; 
            refCtx.textAlign = "center"; refCtx.textBaseline = "middle";
            refCtx.fillStyle = "black"; 
            refCtx.fillText(letter, refCanvas.width / 2, refCanvas.height / 2);

            for (let y = 0; y < canvas.height; y += gridSize) {
                for (let x = 0; x < canvas.width; x += gridSize) {
                    const imgData = refCtx.getImageData(x, y, gridSize, gridSize);
                    let hasContent = false;
                    for (let i = 0; i < imgData.data.length; i += 4) {
                        if (imgData.data[i + 3] > 50) { hasContent = true; break; }
                    }
                    if (hasContent) targetBlocks.push({ x, y });
                }
            }
        }

        function loadLetter(index) {
            const item = gameData.alphabet[index];
            if (!item) return;

            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('congrats-overlay').style.display = 'none';
            document.getElementById('level-complete-overlay').style.display = 'none';
            
            isCompleted = false;
            hasStartedDrawing = false;
            attemptCount = 0;
            
            document.getElementById('game-title').textContent = `Gabriel - N√≠vel ${gameData.level}`;
            document.body.className = `level-${gameData.level}`;

            let instruction = "";
            switch(gameData.level) {
                case 1: case 4: instruction = "Desenhe a letra!"; break;
                case 2: case 5: instruction = "Apague a letra!"; break;
                case 3: case 6: instruction = "Arraste a letra!"; break;
            }
            document.getElementById('instruction-bar').textContent = instruction;

            if (gameData.level === 3 || gameData.level === 6) {
                setupDragDropLevel(item);
            } else {
                setupStandardLevels(item);
            }

            const card = document.getElementById('card-side');
            card.style.animation = 'none'; void card.offsetWidth; card.style.animation = 'pop 0.4s forwards';

            setTimeout(() => speakCurrent(), 400);
        }

        function setupStandardLevels(item) {
            document.getElementById('canvas-container').style.display = 'flex';
            document.getElementById('drag-drop-container').style.display = 'none';
            document.getElementById('standard-controls').style.display = 'flex';
            document.getElementById('animal-image').style.display = 'block';
            document.getElementById('audio-central-msg').style.display = 'none';
            
            const preImg = preloadedImages[item.l];
            document.getElementById('animal-image').src = (preImg && preImg.complete) ? preImg.src : `https://marciasiri.github.io/leitura_Gabriel/${item.l.toLowerCase()}_${removeAccents(item.name)}.jpg`;
            
            renderLetterTemplate();
        }

        function setupDragDropLevel(item) {
            document.getElementById('canvas-container').style.display = 'none';
            document.getElementById('drag-drop-container').style.display = 'flex';
            document.getElementById('standard-controls').style.display = 'none';
            document.getElementById('animal-image').style.display = 'none';
            document.getElementById('audio-central-msg').style.display = 'block';

            const isLowercase = gameData.level === 6;
            const targetChar = isLowercase ? item.l.toLowerCase() : item.l;

            const dropZone = document.getElementById('drop-zone');
            dropZone.innerHTML = '<i class="fas fa-question"></i>';
            dropZone.style.borderStyle = 'dashed';

            const options = [targetChar];
            const others = gameData.alphabet.filter(a => a.l !== item.l);
            for (let i = 0; i < 2; i++) {
                const rand = Math.floor(Math.random() * others.length);
                const char = others.splice(rand, 1)[0].l;
                options.push(isLowercase ? char.toLowerCase() : char);
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            options.forEach(l => {
                const card = document.createElement('div');
                card.className = 'letter-card';
                card.textContent = l;
                card.draggable = true;
                
                card.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', l);
                    card.classList.add('dragging');
                });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));

                let initialX, initialY;
                card.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    initialX = touch.clientX;
                    initialY = touch.clientY;
                    card.style.position = 'fixed';
                    card.style.zIndex = '1000';
                    card.classList.add('dragging');
                });
                
                card.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    card.style.left = (touch.clientX - 40) + 'px';
                    card.style.top = (touch.clientY - 50) + 'px';
                });

                card.addEventListener('touchend', (e) => {
                    card.classList.remove('dragging');
                    const touch = e.changedTouches[0];
                    const dzRect = dropZone.getBoundingClientRect();
                    
                    if (touch.clientX > dzRect.left && touch.clientX < dzRect.right &&
                        touch.clientY > dzRect.top && touch.clientY < dzRect.bottom) {
                        checkLevelDrop(l);
                    } else {
                        card.style.position = 'static';
                    }
                });

                container.appendChild(card);
            });
        }

        const dz = document.getElementById('drop-zone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('hover'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('hover'));
        dz.addEventListener('drop', (e) => {
            e.preventDefault();
            dz.classList.remove('hover');
            const dropped = e.dataTransfer.getData('text/plain');
            checkLevelDrop(dropped);
        });

        function checkLevelDrop(letter) {
            const item = gameData.alphabet[gameData.currentIndex];
            const correct = (gameData.level === 6) ? item.l.toLowerCase() : item.l;
            
            if (letter === correct) {
                const dropZone = document.getElementById('drop-zone');
                dropZone.textContent = letter;
                dropZone.style.borderStyle = 'solid';
                showSuccess();
            } else {
                attemptCount++;
                speak("Ops! Tente novamente!");
                if (attemptCount >= 2) document.getElementById('skip-btn').style.display = 'flex';
                dz.style.borderColor = 'red';
                setTimeout(() => dz.style.borderColor = '', 500);
            }
        }

        function speakCurrent() {
            const item = gameData.alphabet[gameData.currentIndex];
            let audioText = item.l;

            if (item.l === 'A') {
                let instructionSpeech = "";
                switch(gameData.level) {
                    case 1: case 4: instructionSpeech = "Desenhe a letra "; break;
                    case 2: case 5: instructionSpeech = "Apague a letra "; break;
                    case 3: case 6: instructionSpeech = "Arraste a letra "; break;
                }
                audioText = instructionSpeech + item.l;
            }
            
            speak(audioText, () => {
                setTimeout(() => speak(item.name), 500);
            });
        }

        function speak(text, callback) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR'; utterance.rate = 1.4; 
            const voices = window.speechSynthesis.getVoices();
            const fem = voices.find(v => v.lang.includes('pt-BR') && (v.name.includes('Maria') || v.name.includes('Luciana') || v.name.includes('Victoria'))) || voices.find(v => v.lang.includes('pt-BR'));
            if (fem) utterance.voice = fem;
            if (callback) utterance.onend = callback;
            window.speechSynthesis.speak(utterance);
        }

        function manualCheck() {
            if (isCompleted || [3, 6].includes(gameData.level)) return;
            const percentage = (visitedBlocks.size / targetBlocks.length) * 100;
            const isErasing = [2, 5].includes(gameData.level);
            const required = isErasing ? 80 : 65;

            if (percentage >= required) {
                showSuccess();
            } else {
                attemptCount++;
                speak("Quase, Gabriel! Tente novamente!");
                document.getElementById('canvas-container').classList.add('blink-error');
                setTimeout(() => {
                    document.getElementById('canvas-container').classList.remove('blink-error');
                    resetCanvas(); 
                }, 1000);
            }
        }

        function showSuccess() {
            isCompleted = true;
            if (![3, 6].includes(gameData.level)) {
                document.getElementById('congrats-overlay').style.display = 'flex';
                speak("Muito bem! Voc√™ conseguiu!");
            } else {
                speak("Muito bem! Voc√™ acertou a letra!");
            }
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            createConfetti();
        }

        function createConfetti() {
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                star.className = 'confetti-star'; star.innerHTML = '‚≠ê';
                star.style.left = Math.random() * 100 + 'vw'; star.style.top = '-50px';
                star.style.animationDuration = (Math.random() * 1.5 + 1) + 's';
                document.body.appendChild(star);
                setTimeout(() => star.remove(), 2500);
            }
        }

        function nextLetter() {
            gameData.currentIndex++;
            if (gameData.currentIndex < gameData.alphabet.length) {
                saveProgress();
                loadLetter(gameData.currentIndex);
            } else {
                showLevelComplete();
            }
        }

        function skipLetter() {
            const itemToSkip = gameData.alphabet.splice(gameData.currentIndex, 1)[0];
            gameData.alphabet.push(itemToSkip);
            if (gameData.currentIndex >= gameData.alphabet.length) gameData.currentIndex = 0;
            saveProgress(); loadLetter(gameData.currentIndex);
            speak("Tudo bem! Vamos ver essa depois.");
        }

        function showLevelComplete() {
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('canvas-container').style.display = 'flex';
            document.getElementById('drag-drop-container').style.display = 'none';

            const overlay = document.getElementById('level-complete-overlay');
            overlay.style.display = 'flex';
            
            let msg = "";
            switch(gameData.level) {
                case 1: msg = "Parab√©ns! N√≠vel 1 Conclu√≠do!"; break;
                case 2: msg = "Incr√≠vel! N√≠vel 2 Conclu√≠do!"; break;
                case 3: msg = "Excelente! N√≠vel 3 Conclu√≠do!"; break;
                case 4: msg = "√ìtimo! N√≠vel 4 Conclu√≠do!"; break;
                case 5: msg = "Fant√°stico! N√≠vel 5 Conclu√≠do!"; break;
                case 6: msg = "Uau! Gabriel, voc√™ √© um mestre do Alfabeto!"; break;
            }
            
            document.getElementById('level-msg').textContent = msg;
            speak(msg);
            createConfetti();
        }

        function startNextLevel() {
            document.getElementById('level-complete-overlay').style.display = 'none';
            if (gameData.level < 6) {
                gameData.level++;
            } else {
                gameData.level = 1; 
            }
            document.getElementById('level-select').value = gameData.level;
            gameData.currentIndex = 0;
            gameData.alphabet.sort((a, b) => a.l.localeCompare(b.l));
            saveProgress(); 
            loadLetter(0);
        }

        function jumpToLevel(lvl) {
            gameData.level = parseInt(lvl);
            gameData.currentIndex = 0;
            gameData.alphabet.sort((a, b) => a.l.localeCompare(b.l));
            saveProgress();
            loadLetter(0);
        }

        function resetCanvas() {
            renderLetterTemplate();
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = (attemptCount >= 2) ? 'flex' : 'none';
            document.getElementById('congrats-overlay').style.display = 'none';
            isCompleted = false; hasStartedDrawing = false;
        }

        function startDrawing(e) {
            if (isCompleted || [3, 6].includes(gameData.level)) return;
            isDrawing = true;
            if (!hasStartedDrawing) {
                hasStartedDrawing = true;
                document.getElementById('check-btn').style.display = 'flex';
                document.getElementById('retry-btn').style.display = 'flex';
                if(attemptCount >= 2) document.getElementById('skip-btn').style.display = 'flex';
            }
            ctx.beginPath();
            const pos = getMousePos(e);
            ctx.moveTo(pos.x, pos.y);
            markBlocks(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing || isCompleted || [3, 6].includes(gameData.level)) return;
            const pos = getMousePos(e);
            ctx.lineTo(pos.x, pos.y);
            
            // N√≠veis 2 e 5: Borracha Branca | N√≠veis 1 e 4: L√°pis Vermelho
            ctx.strokeStyle = ([2, 5].includes(gameData.level)) ? "white" : "#FF6B6B";
            
            // L√°pis/Borracha
            if (gameData.level === 4) {
                ctx.lineWidth = 30; // L√°pis fino para desenhar min√∫sculas
            } else if (gameData.level === 5) {
                ctx.lineWidth = 40; // Borracha mais grossa para apagar min√∫sculas
            } else if (gameData.level === 2) {
                ctx.lineWidth = 45; // Borracha original para mai√∫sculas
            } else {
                ctx.lineWidth = 45; // L√°pis padr√£o
            }
            
            ctx.lineCap = "round"; ctx.lineJoin = "round";
            ctx.stroke();
            markBlocks(pos.x, pos.y);
        }

        function markBlocks(x, y) {
            // Raio de colis√£o ajustado para acompanhar a espessura visual
            let threshold = 35;
            if (gameData.level === 4) threshold = 25;
            if (gameData.level === 5) threshold = 30;

            targetBlocks.forEach((block, index) => {
                if (!visitedBlocks.has(index)) {
                    const dist = Math.hypot(x - (block.x + gridSize/2), y - (block.y + gridSize/2));
                    if (dist < threshold) visitedBlocks.add(index);
                }
            });
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) * (canvas.width / rect.width), y: (clientY - rect.top) * (canvas.height / rect.height) };
        }

        async function init() {
            initCanvas();
            preloadAll();

            const forceLoad = () => {
                if (document.getElementById('loader').style.display !== 'none') {
                    loadLetter(gameData.currentIndex);
                    document.getElementById('loader').style.display = 'none';
                }
            };
            const safetyTimeout = setTimeout(forceLoad, 2500);

            try {
                if (typeof firebase !== 'undefined' && auth) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else { 
                        await auth.signInAnonymously(); 
                    }
                    await loadProgress();
                }
            } catch (e) {} finally {
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                window.addEventListener('mouseup', () => isDrawing = false);
                canvas.addEventListener('touchstart', (e) => { if(![3, 6].includes(gameData.level)) e.preventDefault(); startDrawing(e); }, {passive: false});
                canvas.addEventListener('touchmove', (e) => { if(![3, 6].includes(gameData.level)) e.preventDefault(); draw(e); }, {passive: false});
                canvas.addEventListener('touchend', () => isDrawing = false);

                clearTimeout(safetyTimeout);
                forceLoad();
            }
        }

        window.onload = init;
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
        }
    </script>
</body>
</html>
