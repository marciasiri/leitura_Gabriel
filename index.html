<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alfabeto do Gabriel</title>
    <!-- Fontes e √çcones (Fallback offline para Arial caso n√£o haja internet) -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFE66D;
            --success-color: #58D68D;
            --skip-color: #AAB7B8;
            --level-color-1: #FF6B6B;
            --level-color-2: #3498db;
            --level-color-3: #9b59b6;
            --level-color-4: #f39c12;
            --level-color-5: #e67e22;
            --level-color-6: #1abc9c;
            --level-color-7: #e91e63;
            --text-color: #2F2F2F;
            --bg-color: #F7FFF7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Fredoka One', cursive, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
            display: flex; flex-direction: column;
            touch-action: manipulation;
        }

        header {
            padding: 10px; text-align: center; background-color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 10;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }

        .header-top {
            display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;
        }

        #instruction-bar {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 5px 20px;
            border-radius: 20px;
            font-size: 1.1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 5px;
            animation: pulse-light 2s infinite;
        }

        @keyframes pulse-light { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }

        .level-selector {
            background: #eee;
            border: 2px solid #ccc;
            padding: 8px 15px;
            border-radius: 15px;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            color: #555;
            cursor: pointer;
            outline: none;
        }

        .game-container {
            display: flex; flex: 1; padding: 15px; gap: 15px;
            align-items: center; justify-content: center;
            overflow: hidden;
        }

        .card-side {
            flex: 1; background: white; border-radius: 30px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 10px 10px 0px var(--secondary-color);
            border: 4px solid var(--text-color); height: 400px; max-width: 45%;
            transition: all 0.3s ease;
        }

        .animal-img {
            max-width: 95%; max-height: 320px; object-fit: contain;
            margin-bottom: 10px; border-radius: 20px;
        }

        .drawing-side {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative; width: 100%;
        }

        #canvas-container {
            position: relative; background: white; border-radius: 30px;
            border: 6px dashed var(--primary-color);
            box-shadow: 10px 10px 0px var(--accent-color);
            cursor: crosshair; overflow: hidden; transition: all 0.3s ease;
            touch-action: none; margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
            width: 400px; height: 400px;
        }

        #letter-canvas { display: block; width: 100%; height: 100%; }

        #drag-drop-container {
            display: none; flex-direction: column; align-items: center; gap: 15px; width: 100%;
        }

        .drop-zone {
            width: 180px; height: 180px; border-radius: 30px; display: flex;
            align-items: center; justify-content: center; font-size: 5rem;
            position: relative; transition: all 0.3s;
            font-family: sans-serif;
            font-weight: bold;
        }
        
        body.level-1 #canvas-container { border-color: var(--level-color-1); }
        body.level-2 #canvas-container { border-color: var(--level-color-2); }
        body.level-3 .drop-zone { border: 6px dashed var(--level-color-3); color: var(--level-color-3); background: rgba(155, 89, 182, 0.05); }
        body.level-4 #canvas-container { border-color: var(--level-color-4); }
        body.level-5 #canvas-container { border-color: var(--level-color-5); }
        body.level-6 .drop-zone { border: 6px dashed var(--level-color-6); color: var(--level-color-6); background: rgba(26, 188, 156, 0.05); }
        body.level-7 .drop-zone { border: 6px dashed var(--level-color-7); color: var(--level-color-7); background: rgba(233, 30, 99, 0.05); width: 240px; font-size: 4rem; }

        .options-container {
            display: flex; gap: 15px; justify-content: center; width: 100%; flex-wrap: wrap;
        }

        .letter-card {
            width: 90px; height: 110px; background: white; border: 4px solid var(--text-color);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; cursor: grab; transition: transform 0.1s, box-shadow 0.2s;
            touch-action: none;
            font-family: sans-serif;
            font-weight: bold;
            z-index: 5;
        }
        body.level-3 .letter-card { box-shadow: 5px 5px 0px var(--level-color-3); }
        body.level-6 .letter-card { box-shadow: 5px 5px 0px var(--level-color-6); }
        body.level-7 .letter-card { box-shadow: 5px 5px 0px var(--level-color-7); width: 80px; height: 100px; font-size: 2.6rem; }
        
        .letter-card.dragging { opacity: 0.8; transform: scale(1.1); z-index: 1000; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }

        .controls {
            margin-top: 15px; display: flex; gap: 20px;
            min-height: 80px; align-items: center; justify-content: center; width: 100%;
        }

        .btn {
            border: none; border-radius: 50%; width: 65px; height: 65px;
            font-size: 1.6rem; cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15);
        }

        .btn:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.15); }
        .btn-audio { 
            background-color: var(--secondary-color); color: white; border-radius: 50px; 
            width: auto; padding: 12px 30px; height: auto; gap: 10px;
            font-size: 1.4rem;
        }
        
        .btn-retry, .btn-check, .btn-skip { display: none; }
        .btn-retry { background-color: var(--primary-color); color: white; }
        .btn-check { 
            background-color: var(--success-color); color: white; width: 85px; height: 85px; font-size: 2.4rem;
            animation: pulse-check 2s infinite ease-in-out;
        }
        .btn-skip { background-color: var(--skip-color); color: white; }
        
        .btn-next { 
            background-color: var(--success-color); color: white; position: fixed; bottom: 20px; right: 20px;
            padding: 20px 45px; font-size: 2.2rem; display: none; z-index: 100; border-radius: 50px; width: auto; height: auto;
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.96); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            border-radius: 30px; z-index: 50; text-align: center; padding: 15px;
        }

        .star-icon { font-size: 6rem; color: var(--accent-color); filter: drop-shadow(0 0 10px orange); }

        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-color);
            display: flex; align-items:center; justify-content: center; z-index: 2000; font-size: 2rem;
        }

        .confetti-star { position: absolute; font-size: 2rem; pointer-events: none; z-index: 60; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(360deg); opacity: 0; } }
        .bounce { animation: bounce 0.6s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .pop-in { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        @media (max-width: 850px) {
            header { padding: 8px 5px; }
            .header-top { gap: 10px; }
            .game-container { flex-direction: column; padding-bottom: 100px; }
            .card-side { width: 95vw; height: 260px; max-width: 95%; margin-bottom: 10px; }
            #canvas-container { width: 85vw; height: 85vw; max-width: 320px; max-height: 320px; }
            .letter-card { width: 75px; height: 95px; font-size: 2.2rem; }
            body.level-7 .letter-card { width: 60px; height: 75px; font-size: 2rem; }
        }
    </style>
</head>
<body>

    <div id="loader">Carregando jogo do Gabriel...</div>

    <header>
        <div class="header-top">
            <h1 id="game-title" style="margin:0; font-size: 1.4rem;">Gabriel - N√≠vel 1</h1>
            <select class="level-selector" id="level-select" onchange="jumpToLevel(this.value)">
                <option value="1">N√≠vel 1 (Mai√∫sculas - Desenhar)</option>
                <option value="2">N√≠vel 2 (Mai√∫sculas - Apagar)</option>
                <option value="3">N√≠vel 3 (Mai√∫sculas - Arrastar)</option>
                <option value="4">N√≠vel 4 (Min√∫sculas - Desenhar)</option>
                <option value="5">N√≠vel 5 (Min√∫sculas - Apagar)</option>
                <option value="6">N√≠vel 6 (Min√∫sculas - Arrastar)</option>
                <option value="7">N√≠vel 7 (Par - Mai√∫scula/Min√∫scula)</option>
            </select>
        </div>
        <div id="instruction-bar">Instru√ß√£o</div>
    </header>

    <div class="game-container">
        <div class="card-side pop-in" id="card-side">
            <img src="" alt="" id="animal-image" class="animal-img">
            <div id="audio-central-msg" style="display:none; font-size: 1.2rem; margin-bottom: 20px; text-align: center;">Ou√ßa e arraste as letras!</div>
            <button class="btn btn-audio" id="audio-btn" onclick="speakCurrent()">
                <i class="fas fa-volume-high"></i>&nbsp;Ouvir
            </button>
        </div>

        <div class="drawing-side">
            <div id="canvas-container">
                <canvas id="letter-canvas"></canvas>
                
                <div id="congrats-overlay" class="overlay">
                    <div class="star-icon bounce">‚≠ê</div>
                    <h2 style="font-size: 2.2rem; color: var(--success-color); margin: 10px 0;">MUITO BEM!</h2>
                </div>

                <div id="level-complete-overlay" class="overlay">
                    <div class="star-icon bounce">üèÜ</div>
                    <h2 id="level-msg" style="font-size: 1.5rem; color: var(--primary-color); margin: 15px 0;">Parab√©ns Gabriel!</h2>
                    <button class="btn btn-audio proeminent" style="width:100%; max-width: 280px; background-color: var(--success-color); border-radius: 50px;" onclick="startNextLevel()">
                        Continuar <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div id="drag-drop-container">
                <div class="drop-zone" id="drop-zone">
                    <i class="fas fa-question"></i>
                </div>
                <div class="options-container" id="options-container"></div>
            </div>

            <div class="controls" id="standard-controls">
                <button id="retry-btn" class="btn btn-retry" onclick="resetCanvas()"><i class="fas fa-eraser"></i></button>
                <button id="check-btn" class="btn btn-check" onclick="manualCheck()"><i class="fas fa-check-circle"></i></button>
                <button id="skip-btn" class="btn btn-skip" onclick="skipLetter()"><i class="fas fa-forward"></i></button>
            </div>
        </div>
    </div>

    <button id="next-btn" class="btn btn-next pop-in" onclick="nextLetter()">Pr√≥ximo <i class="fas fa-arrow-right"></i></button>

    <canvas id="ref-canvas" style="display:none;"></canvas>

    <script>
        // --- PROTE√á√ÉO DE CONFIGURA√á√ÉO (OFFLINE/LOCAL) ---
        let db, auth, appId = 'gabriel-alfabeto';
        try {
            if (typeof window.firebase !== 'undefined' && window.__firebase_config) {
                const config = JSON.parse(window.__firebase_config);
                firebase.initializeApp(config);
                db = firebase.firestore();
                auth = firebase.auth();
            }
            if (typeof window.__app_id !== 'undefined') appId = window.__app_id;
        } catch (e) { console.warn("Fallback para modo local ativado."); }

        const IMAGE_BASE_URL = './'; // Busca na mesma pasta do arquivo HTML

        // --- DADOS DO ALFABETO ---
        let gameData = {
            level: 1,
            currentIndex: 0,
            alphabet: [
                { l: 'A', name: 'Abelha' }, { l: 'B', name: 'Bola' }, { l: 'C', name: 'Casa' },
                { l: 'D', name: 'Dado' }, { l: 'E', name: 'Elefante' }, { l: 'F', name: 'Faca' },
                { l: 'G', name: 'Gato' }, { l: 'H', name: 'Helic√≥ptero' }, { l: 'I', name: 'Igreja' },
                { l: 'J', name: 'Jacar√©' }, { l: 'K', name: 'Kiwi' }, { l: 'L', name: 'L√°pis' },
                { l: 'M', name: 'Macaco' }, { l: 'N', name: 'Navio' }, { l: 'O', name: 'Ovelha' },
                { l: 'P', name: 'Pato' }, { l: 'Q', name: 'Queijo' }, { l: 'R', name: 'Rato' },
                { l: 'S', name: 'Sapo' }, { l: 'T', name: 'Tesoura' }, { l: 'U', name: 'Uva' },
                { l: 'V', name: 'Vaca' }, { l: 'W', name: 'Walter' }, { l: 'X', name: 'X√≠cara' },
                { l: 'Y', name: 'Yakult' }, { l: 'Z', name: 'Zebra' }
            ],
            // Sequ√™ncia solicitada N√≠vel 7: a e i o u y b z c x d w f v g t h s j r k p l n m q
            level7Sequence: "AEIOUYBZCXDFVGTSHSJRKLPNMQ".split("")
        };

        let level7Match = { upper: false, lower: false };
        let attemptCount = 0;
        let isDrawing = false;
        let isCompleted = false;
        let hasStartedDrawing = false;
        let visitedBlocks = new Set();
        let targetBlocks = [];
        const gridSize = 15;
        const canvasSize = { w: 400, h: 400 };

        let canvas, ctx, refCanvas, refCtx;
        const preloadedImages = {};

        async function saveProgress() {
            if (!db || !auth || !auth.currentUser) return;
            try {
                await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/data/progress`).set({
                    level: gameData.level,
                    currentIndex: gameData.currentIndex,
                    updatedAt: new Date()
                });
            } catch (e) {}
        }

        async function loadProgress() {
            if (!db || !auth || !auth.currentUser) return;
            try {
                const doc = await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/data/progress`).get();
                if (doc.exists) {
                    const data = doc.data();
                    gameData.level = data.level || 1;
                    gameData.currentIndex = data.currentIndex || 0;
                    document.getElementById('level-select').value = gameData.level;
                }
            } catch (e) {}
        }

        function removeAccents(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

        function preloadAll() {
            gameData.alphabet.forEach(item => {
                const img = new Image();
                img.src = `${IMAGE_BASE_URL}${item.l.toLowerCase()}_${removeAccents(item.name)}.jpg`;
                preloadedImages[item.l] = img;
            });
        }

        function initCanvas() {
            canvas = document.getElementById('letter-canvas');
            if (!canvas) return;
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            refCanvas = document.getElementById('ref-canvas');
            refCtx = refCanvas.getContext('2d', { willReadFrequently: true });
            canvas.width = canvasSize.w; canvas.height = canvasSize.h;
            refCanvas.width = canvasSize.w; refCanvas.height = canvasSize.h;
        }

        function renderLetterTemplate() {
            if (!ctx || [3, 6, 7].includes(gameData.level)) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            refCtx.clearRect(0, 0, refCanvas.width, refCanvas.height);
            visitedBlocks.clear(); targetBlocks = [];
            
            let letter = gameData.alphabet[gameData.currentIndex].l;
            const isLower = [4, 5].includes(gameData.level);
            if (isLower) letter = letter.toLowerCase();
            
            const fontSize = isLower ? "340px" : "300px";
            ctx.font = "bold " + fontSize + " sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle";

            if ([1, 4].includes(gameData.level)) {
                ctx.strokeStyle = "#CCCCCC"; ctx.setLineDash([15, 15]); ctx.lineWidth = 6;
                ctx.strokeText(letter, canvas.width / 2, canvas.height / 2);
                ctx.setLineDash([]);
            } else {
                ctx.font = "100 " + fontSize + " sans-serif"; ctx.fillStyle = "#CCCCCC";
                ctx.fillText(letter, canvas.width / 2, canvas.height / 2);
            }

            refCtx.font = "bold " + fontSize + " sans-serif"; refCtx.textAlign = "center"; refCtx.textBaseline = "middle";
            refCtx.fillStyle = "black"; refCtx.fillText(letter, refCanvas.width / 2, refCanvas.height / 2);

            for (let y = 0; y < canvas.height; y += gridSize) {
                for (let x = 0; x < canvas.width; x += gridSize) {
                    const imgData = refCtx.getImageData(x, y, gridSize, gridSize);
                    let hasContent = false;
                    for (let i = 0; i < imgData.data.length; i += 4) { if (imgData.data[i + 3] > 50) { hasContent = true; break; } }
                    if (hasContent) targetBlocks.push({ x, y });
                }
            }
        }

        function loadLetter(index) {
            let item = (gameData.level === 7) ? gameData.alphabet.find(a => a.l === gameData.level7Sequence[index]) : gameData.alphabet[index];
            if (!item) return;

            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            document.getElementById('congrats-overlay').style.display = 'none';
            document.getElementById('level-complete-overlay').style.display = 'none';
            
            isCompleted = false; hasStartedDrawing = false; attemptCount = 0;
            level7Match = { upper: false, lower: false };
            document.getElementById('game-title').textContent = `Gabriel - N√≠vel ${gameData.level}`;
            document.body.className = `level-${gameData.level}`;

            const instructions = { 1: "Desenhe a letra!", 4: "Desenhe a letra!", 2: "Apague a letra!", 5: "Apague a letra!", 3: "Arraste a letra!", 6: "Arraste a letra!", 7: "Arraste o par de letras!" };
            document.getElementById('instruction-bar').textContent = instructions[gameData.level] || "";

            if ([3, 6, 7].includes(gameData.level)) setupDragDropLevel(item);
            else setupStandardLevels(item);

            const card = document.getElementById('card-side');
            card.style.animation = 'none'; void card.offsetWidth; card.style.animation = 'pop 0.4s forwards';
            setTimeout(() => speakCurrent(), 400);
        }

        function setupStandardLevels(item) {
            document.getElementById('canvas-container').style.display = 'flex';
            document.getElementById('drag-drop-container').style.display = 'none';
            document.getElementById('standard-controls').style.display = 'flex';
            document.getElementById('animal-image').style.display = 'block';
            document.getElementById('audio-central-msg').style.display = 'none';
            const preImg = preloadedImages[item.l];
            document.getElementById('animal-image').src = (preImg && preImg.complete) ? preImg.src : `${IMAGE_BASE_URL}${item.l.toLowerCase()}_${removeAccents(item.name)}.jpg`;
            renderLetterTemplate();
        }

        function setupDragDropLevel(item) {
            document.getElementById('canvas-container').style.display = 'none';
            document.getElementById('drag-drop-container').style.display = 'flex';
            document.getElementById('standard-controls').style.display = 'none';
            document.getElementById('animal-image').style.display = 'none';
            document.getElementById('audio-central-msg').style.display = 'block';

            const dropZone = document.getElementById('drop-zone');
            dropZone.innerHTML = '<i class="fas fa-question"></i>'; dropZone.style.borderStyle = 'dashed';

            let options = [];
            if (gameData.level === 7) {
                options.push(item.l, item.l.toLowerCase());
                const others = gameData.alphabet.filter(a => a.l !== item.l).sort(() => 0.5 - Math.random());
                for (let i = 0; i < 2; i++) options.push(others[i].l, others[i].l.toLowerCase());
            } else {
                const target = gameData.level === 6 ? item.l.toLowerCase() : item.l;
                options.push(target);
                const others = gameData.alphabet.filter(a => a.l !== item.l).sort(() => 0.5 - Math.random());
                for (let i = 0; i < 2; i++) options.push(gameData.level === 6 ? others[i].l.toLowerCase() : others[i].l);
            }
            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('options-container'); container.innerHTML = '';
            options.forEach(l => {
                const card = document.createElement('div');
                card.className = 'letter-card'; card.textContent = l; card.draggable = true;
                
                // Suporte a Toque para Tablet
                let startX, startY;
                card.addEventListener('touchstart', (e) => {
                    const t = e.touches[0]; startX = t.clientX; startY = t.clientY;
                    card.classList.add('dragging'); card.style.position = 'fixed'; card.style.zIndex = '1000';
                });
                card.addEventListener('touchmove', (e) => {
                    const t = e.touches[0]; card.style.left = (t.clientX - 45) + 'px'; card.style.top = (t.clientY - 55) + 'px';
                });
                card.addEventListener('touchend', (e) => {
                    card.classList.remove('dragging'); const t = e.changedTouches[0];
                    const dzRect = dropZone.getBoundingClientRect();
                    if (t.clientX > dzRect.left && t.clientX < dzRect.right && t.clientY > dzRect.top && t.clientY < dzRect.bottom) {
                        if (checkLevelDrop(l)) { card.style.display = 'none'; return; }
                    }
                    card.style.position = 'static'; card.style.left = ''; card.style.top = '';
                });

                // Mouse (PC)
                card.addEventListener('dragstart', (e) => { e.dataTransfer.setData('text/plain', l); card.classList.add('dragging'); });
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
                container.appendChild(card);
            });
        }

        const dz = document.getElementById('drop-zone');
        dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('hover'); });
        dz.addEventListener('dragleave', () => dz.classList.remove('hover'));
        dz.addEventListener('drop', (e) => {
            e.preventDefault(); dz.classList.remove('hover');
            const dropped = e.dataTransfer.getData('text/plain');
            if (checkLevelDrop(dropped)) {
                const cards = document.querySelectorAll('.letter-card');
                cards.forEach(c => { if(c.textContent === dropped) c.style.display = 'none'; });
            }
        });

        function checkLevelDrop(letter) {
            let item = (gameData.level === 7) ? gameData.alphabet.find(a => a.l === gameData.level7Sequence[gameData.currentIndex]) : gameData.alphabet[gameData.currentIndex];
            if (gameData.level === 7) {
                const isUpper = letter === item.l; const isLower = letter === item.l.toLowerCase();
                if (isUpper || isLower) {
                    if (isUpper) level7Match.upper = true; if (isLower) level7Match.lower = true;
                    let display = "";
                    if (level7Match.upper) display += item.l + " "; if (level7Match.lower) display += item.l.toLowerCase();
                    dz.textContent = display.trim();
                    if (level7Match.upper && level7Match.lower) { dz.style.borderStyle = 'solid'; showSuccess(); }
                    return true;
                }
            } else {
                const correct = (gameData.level === 6) ? item.l.toLowerCase() : item.l;
                if (letter === correct) { dz.textContent = letter; dz.style.borderStyle = 'solid'; showSuccess(); return true; }
            }
            attemptCount++; speak("Ops! Tente novamente!");
            if (attemptCount >= 2) document.getElementById('skip-btn').style.display = 'flex';
            dz.style.borderColor = 'red'; setTimeout(() => dz.style.borderColor = '', 500);
            return false;
        }

        function speakCurrent() {
            let item = (gameData.level === 7) ? gameData.alphabet.find(a => a.l === gameData.level7Sequence[gameData.currentIndex]) : gameData.alphabet[gameData.currentIndex];
            if (!item) return;
            let text = item.l;
            if ((gameData.level === 7 && gameData.currentIndex === 0) || item.l === 'A') {
                const prefix = { 1: "Desenhe a letra ", 4: "Desenhe a letra ", 2: "Apague a letra ", 5: "Apague a letra ", 3: "Arraste a letra ", 6: "Arraste a letra ", 7: "Arraste o par da letra " };
                text = (prefix[gameData.level] || "") + item.l;
            }
            speak(text, () => setTimeout(() => speak(item.name), 500));
        }

        function speak(text, callback) {
            if (!window.speechSynthesis) return; window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text); u.lang = 'pt-BR'; u.rate = 1.3; 
            const vs = window.speechSynthesis.getVoices();
            const f = vs.find(v => v.lang.includes('pt-BR') && (v.name.includes('Maria') || v.name.includes('Luciana'))) || vs.find(v => v.lang.includes('pt-BR'));
            if (f) u.voice = f; if (callback) u.onend = callback;
            window.speechSynthesis.speak(u);
        }

        function manualCheck() {
            if (isCompleted || [3, 6, 7].includes(gameData.level)) return;
            const percentage = (visitedBlocks.size / targetBlocks.length) * 100;
            const required = [2, 5].includes(gameData.level) ? 80 : 65;
            if (percentage >= required) showSuccess();
            else {
                attemptCount++; speak("Quase, Gabriel! Tente novamente!");
                document.getElementById('canvas-container').classList.add('blink-error');
                setTimeout(() => { document.getElementById('canvas-container').classList.remove('blink-error'); resetCanvas(); }, 1000);
            }
        }

        function showSuccess() {
            isCompleted = true;
            if (![3, 6, 7].includes(gameData.level)) document.getElementById('congrats-overlay').style.display = 'flex';
            speak("Muito bem! Voc√™ conseguiu!");
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = 'none';
            createConfetti();
        }

        function createConfetti() {
            for (let i = 0; i < 20; i++) {
                const s = document.createElement('div'); s.className = 'confetti-star'; s.innerHTML = '‚≠ê';
                s.style.left = Math.random() * 100 + 'vw'; s.style.top = '-50px';
                s.style.animationDuration = (Math.random() * 1.5 + 1) + 's';
                document.body.appendChild(s); setTimeout(() => s.remove(), 2500);
            }
        }

        function nextLetter() {
            gameData.currentIndex++;
            const max = (gameData.level === 7) ? gameData.level7Sequence.length : gameData.alphabet.length;
            if (gameData.currentIndex < max) { saveProgress(); loadLetter(gameData.currentIndex); }
            else showLevelComplete();
        }

        function skipLetter() {
            if (gameData.level === 7) gameData.currentIndex = (gameData.currentIndex + 1) % gameData.level7Sequence.length;
            else {
                const item = gameData.alphabet.splice(gameData.currentIndex, 1)[0]; gameData.alphabet.push(item);
                if (gameData.currentIndex >= gameData.alphabet.length) gameData.currentIndex = 0;
            }
            saveProgress(); loadLetter(gameData.currentIndex); speak("Tudo bem! Vamos ver essa depois.");
        }

        function showLevelComplete() {
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('canvas-container').style.display = 'flex';
            document.getElementById('drag-drop-container').style.display = 'none';
            const overlay = document.getElementById('level-complete-overlay'); overlay.style.display = 'flex';
            const msgs = ["N√≠vel 1 Conclu√≠do!", "N√≠vel 2 Conclu√≠do!", "N√≠vel 3 Conclu√≠do!", "N√≠vel 4 Conclu√≠do!", "N√≠vel 5 Conclu√≠do!", "N√≠vel 6 Conclu√≠do!", "Mestre do Alfabeto!"];
            const msg = "Parab√©ns Gabriel! " + (msgs[gameData.level - 1] || "");
            document.getElementById('level-msg').textContent = msg;
            speak(msg); createConfetti();
        }

        function startNextLevel() {
            document.getElementById('level-complete-overlay').style.display = 'none';
            gameData.level = gameData.level < 7 ? gameData.level + 1 : 1;
            document.getElementById('level-select').value = gameData.level;
            gameData.currentIndex = 0;
            gameData.alphabet.sort((a, b) => a.l.localeCompare(b.l));
            saveProgress(); loadLetter(0);
        }

        function jumpToLevel(lvl) {
            gameData.level = parseInt(lvl); gameData.currentIndex = 0;
            gameData.alphabet.sort((a, b) => a.l.localeCompare(b.l));
            saveProgress(); loadLetter(0);
        }

        function resetCanvas() {
            renderLetterTemplate();
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('retry-btn').style.display = 'none';
            document.getElementById('skip-btn').style.display = (attemptCount >= 2) ? 'flex' : 'none';
            document.getElementById('congrats-overlay').style.display = 'none';
            isCompleted = false; hasStartedDrawing = false;
        }

        function startDrawing(e) {
            if (isCompleted || [3, 6, 7].includes(gameData.level)) return;
            isDrawing = true;
            if (!hasStartedDrawing) {
                hasStartedDrawing = true; document.getElementById('check-btn').style.display = 'flex'; document.getElementById('retry-btn').style.display = 'flex';
            }
            ctx.beginPath(); const p = getMousePos(e); ctx.moveTo(p.x, p.y); markBlocks(p.x, p.y);
        }

        function draw(e) {
            if (!isDrawing || isCompleted || [3, 6, 7].includes(gameData.level)) return;
            const p = getMousePos(e); ctx.lineTo(p.x, p.y);
            ctx.strokeStyle = ([2, 5].includes(gameData.level)) ? "white" : "#FF6B6B";
            ctx.lineWidth = (gameData.level === 4) ? 30 : (gameData.level === 5 ? 40 : 45);
            ctx.lineCap = "round"; ctx.lineJoin = "round"; ctx.stroke(); markBlocks(p.x, p.y);
        }

        function markBlocks(x, y) {
            let t = 35; if (gameData.level === 4) t = 25; if (gameData.level === 5) t = 30;
            targetBlocks.forEach((b, i) => {
                if (!visitedBlocks.has(i)) { if (Math.hypot(x - (b.x + gridSize/2), y - (b.y + gridSize/2)) < t) visitedBlocks.add(i); }
            });
        }

        function getMousePos(e) {
            const r = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (cx - r.left) * (canvas.width / rect.width), y: (cy - r.top) * (canvas.height / rect.height) };
        }

        async function init() {
            initCanvas(); preloadAll();
            const forceLoad = () => { if (document.getElementById('loader').style.display !== 'none') { loadLetter(gameData.currentIndex); document.getElementById('loader').style.display = 'none'; } };
            const safetyTimeout = setTimeout(forceLoad, 2500);
            try {
                if (typeof firebase !== 'undefined' && auth) {
                    if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) await auth.signInWithCustomToken(window.__initial_auth_token);
                    else await auth.signInAnonymously();
                    await loadProgress();
                }
            } catch (e) {} finally {
                canvas.addEventListener('mousedown', startDrawing); canvas.addEventListener('mousemove', draw); window.addEventListener('mouseup', () => isDrawing = false);
                canvas.addEventListener('touchstart', (e) => { if(![3, 6, 7].includes(gameData.level)) { e.preventDefault(); startDrawing(e); } }, {passive: false});
                canvas.addEventListener('touchmove', (e) => { if(![3, 6, 7].includes(gameData.level)) { e.preventDefault(); draw(e); } }, {passive: false});
                canvas.addEventListener('touchend', () => isDrawing = false);
                clearTimeout(safetyTimeout); forceLoad();
            }
        }

        window.onload = init;
        if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    </script>
</body>
</html>
